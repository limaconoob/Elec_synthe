/* 
 * File:   Main.c
 * Author: bocal
 *
 * Created on June 9, 2016, 5:16 AM
 */

#include "SynthyTwo.h"

void    tab_create(u32 *tab_period)
{
	tab_period[87] = 1194;
	tab_period[86] = 1265;
	tab_period[85] = 1341;
	tab_period[84] = 1420;
	tab_period[83] = 1505;
	tab_period[82] = 1594;
	tab_period[81] = 1689;
	tab_period[80] = 1790;
	tab_period[79] = 1896;
	tab_period[78] = 2009;
	tab_period[77] = 2128;
	tab_period[76] = 2255;
	tab_period[75] = 2389;
	tab_period[74] = 2531;
	tab_period[73] = 2681;
	tab_period[72] = 2841;
	tab_period[71] = 3010;
	tab_period[70] = 3189;
	tab_period[69] = 3379;
	tab_period[68] = 3579;
	tab_period[67] = 3792;
	tab_period[66] = 4018;
	tab_period[65] = 4257;
	tab_period[64] = 4510;
	tab_period[63] = 4778;
	tab_period[62] = 5062;
	tab_period[61] = 5363;
	tab_period[60] = 5682;
	tab_period[59] = 6020;
	tab_period[58] = 6378;
	tab_period[57] = 6757;
	tab_period[56] = 7159;
	tab_period[55] = 7584;
	tab_period[54] = 8035;
	tab_period[53] = 8513;
	tab_period[52] = 9019;
	tab_period[51] = 9556;
	tab_period[50] = 10124;
	tab_period[49] = 10726;
	tab_period[48] = 11364;
	tab_period[47] = 12039;
	tab_period[46] = 12755;
	tab_period[45] = 13514;
	tab_period[44] = 14317;
	tab_period[43] = 15167;
	tab_period[42] = 16071;
	tab_period[41] = 17026;
	tab_period[40] = 18039;
	tab_period[39] = 19111;
	tab_period[38] = 20248;
	tab_period[37] = 21452;
	tab_period[36] = 22727;
	tab_period[35] = 24079;
	tab_period[34] = 25510;
	tab_period[33] = 27027;
	tab_period[32] = 28635;
	tab_period[31] = 30337;
	tab_period[30] = 32141;
	tab_period[29] = 34053;
	tab_period[28] = 36077;
	tab_period[27] = 38223;
	tab_period[26] = 40495;
	tab_period[25] = 42903;
	tab_period[24] = 45455;
	tab_period[23] = 48157;
	tab_period[22] = 51021;
	tab_period[21] = 54055;
	tab_period[20] = 57269;
	tab_period[19] = 60675;
	tab_period[18] = 64282;
	tab_period[17] = 68105;
	tab_period[16] = 72155;
	tab_period[15] = 76445;
	tab_period[14] = 80991;
	tab_period[13] = 85807;
	tab_period[12] = 90909;
	tab_period[11] = 96315;
	tab_period[10] = 102042;
	tab_period[9] = 108110;
	tab_period[8] = 114538;
	tab_period[7] = 121349;
	tab_period[6] = 128565;
	tab_period[5] = 136210;
	tab_period[4] = 144309;
	tab_period[3] = 152890;
	tab_period[2] = 161982;
	tab_period[1] = 171613;
	tab_period[0] = 181818;
}

int     main(int argc, char** argv)
{
    u8          status;
    u8          prev_status;

    TRISDbits.TRISD8 = INPUT;               //Bouton INPUT
    TRISFbits.TRISF1 = OUTPUT;              //LED INPUT
    LATFbits.LATF1 = GND;                   //Etat initial = éteint

    INTCONbits.MVEC = TRUE;           //Multi-vector interrupt mode
    asm volatile("ei");               //Autorise les macro-ASM (interruptions)

    init_lcd();
    lcd_goto(1, 1);
    lcd_print("SPI: ");
    lcd_goto(1, 2);
    lcd_print("OSC: ");
    init_dac();
    init_oscil();
    init_MIDI();

    SPI2BUF = 1;                         //Start SPI2

    tab_create(tab);                        // Remplit le tableau avec les périodes
    cursor = 1000;                          // Détermine la période
   // cursor = 0;

    while(PROCESS)
    {
        status = PORTDbits.RD8;
        if (!status && prev_status)
        {                                   // Appuyer sur le bouton change la fréquence
            if (cursor == 100)
                cursor = 10000;
            else
                cursor /= 10;
        }
        prev_status = status;
        WDTCONbits.WDTCLR = TRUE;       //Clear Watchdog
    }
}

